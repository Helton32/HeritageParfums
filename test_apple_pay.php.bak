<?php

/**
 * Script de test pour vÃ©rifier que la correction Apple Pay fonctionne
 * 
 * Ã€ exÃ©cuter depuis le rÃ©pertoire Laravel : php test_apple_pay.php
 */

require_once 'vendor/autoload.php';

// Charger Laravel
$app = require_once 'bootstrap/app.php';
$kernel = $app->make(Illuminate\Contracts\Console\Kernel::class);
$kernel->bootstrap();

use App\Models\Product;
use App\Models\Order;
use App\Http\Controllers\PaymentController;
use Illuminate\Http\Request;

echo "ðŸ§ª Test de la correction Apple Pay\n";
echo "=================================\n\n";

try {
    // 1. VÃ©rifier qu'il y a des produits
    $product = Product::where('stock', '>', 0)->first();
    
    if (!$product) {
        echo "âŒ Aucun produit en stock trouvÃ©\n";
        exit(1);
    }
    
    echo "âœ… Produit de test trouvÃ©: {$product->name} (Stock: {$product->stock})\n";
    
    // 2. Simuler une requÃªte Apple Pay
    $request = new Request([
        'product_id' => $product->id,
        'quantity' => 1,
        'payment_method' => 'apple_pay_stripe'
    ]);
    
    // 3. Tester la crÃ©ation de session (sans vraiment appeler Stripe)
    echo "ðŸ”„ Simulation de la crÃ©ation d'une commande temporaire...\n";
    
    $subtotal = $product->current_price * 1;
    $taxAmount = $subtotal * 0.20;
    $shippingAmount = $subtotal >= 150 ? 0 : 9.90;
    $total = $subtotal + $taxAmount + $shippingAmount;
    
    // Tester la crÃ©ation d'ordre avec tous les champs requis
    $order = Order::create([
        'order_number' => Order::generateOrderNumber(),
        'status' => 'pending',
        'payment_status' => 'pending',
        'payment_method' => 'apple_pay_stripe',
        'customer_email' => 'test@example.com',
        'customer_name' => 'Test Customer',
        'customer_phone' => null,
        // Champs d'adresse requis
        'billing_address_line_1' => 'Test Address',
        'billing_address_line_2' => null,
        'billing_city' => 'Test City',
        'billing_postal_code' => '12345',
        'billing_country' => 'FR',
        'shipping_address_line_1' => 'Test Address',
        'shipping_address_line_2' => null,
        'shipping_city' => 'Test City',
        'shipping_postal_code' => '12345',
        'shipping_country' => 'FR',
        'shipping_carrier' => 'colissimo',
        'shipping_method' => $shippingAmount == 0 ? 'Gratuite' : 'Express',
        'subtotal' => $subtotal,
        'tax_amount' => $taxAmount,
        'shipping_amount' => $shippingAmount,
        'total_amount' => $total,
        'currency' => 'EUR',
    ]);
    
    echo "âœ… Commande temporaire crÃ©Ã©e avec succÃ¨s: {$order->order_number}\n";
    echo "   - Sous-total: {$subtotal}â‚¬\n";
    echo "   - TVA: {$taxAmount}â‚¬\n";
    echo "   - Livraison: {$shippingAmount}â‚¬\n";
    echo "   - Total: {$total}â‚¬\n\n";
    
    // 4. Nettoyer (supprimer la commande de test)
    $order->delete();
    echo "âœ… Commande de test supprimÃ©e\n\n";
    
    // 5. VÃ©rifier la configuration Stripe
    echo "ðŸ”§ VÃ©rification de la configuration Stripe...\n";
    $stripeKey = config('stripe.secret_key');
    if ($stripeKey && str_starts_with($stripeKey, 'sk_')) {
        echo "âœ… ClÃ© Stripe configurÃ©e\n";
    } else {
        echo "âš ï¸  ClÃ© Stripe non configurÃ©e ou invalide\n";
    }
    
    // 6. VÃ©rifier la configuration Apple Pay
    echo "ðŸŽ VÃ©rification de la configuration Apple Pay...\n";
    $merchantId = config('apple-pay.merchant_identifier');
    $domain = config('apple-pay.domain_name');
    echo "   - Merchant ID: {$merchantId}\n";
    echo "   - Domaine: {$domain}\n";
    
    $certPath = storage_path('apple-pay/merchant_id.pem');
    $keyPath = storage_path('apple-pay/merchant_id.key');
    
    if (file_exists($certPath) && file_exists($keyPath)) {
        echo "âœ… Certificats Apple Pay trouvÃ©s\n";
    } else {
        echo "âš ï¸  Certificats Apple Pay manquants (normal en dÃ©veloppement)\n";
        echo "   - Cert: " . ($certPath ? "âŒ" : "âœ…") . "\n";
        echo "   - Key: " . ($keyPath ? "âŒ" : "âœ…") . "\n";
    }
    
    echo "\nðŸŽ‰ RÃ‰SULTAT: La correction devrait rÃ©soudre l'erreur de crÃ©ation de session !\n";
    echo "\nðŸ“ PROCHAINES Ã‰TAPES:\n";
    echo "1. Tester Apple Pay dans le navigateur\n";
    echo "2. VÃ©rifier les logs en cas d'erreur: storage/logs/laravel.log\n";
    echo "3. S'assurer que l'environnement est en HTTPS pour Apple Pay\n";
    
} catch (\Exception $e) {
    echo "âŒ ERREUR: " . $e->getMessage() . "\n";
    echo "ðŸ“ Fichier: " . $e->getFile() . ":" . $e->getLine() . "\n";
    exit(1);
}
